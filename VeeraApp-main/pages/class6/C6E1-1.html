<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class 6 - Object Detection: Parking Challenge</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- Original HTML File's Basic Structure/Header Styles (Condensed) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', 'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif;
            min-height: 100vh;
            color: #333;
        }

        /* --- Slider Thumb Styles (Essential for Look and Feel) --- */
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-top: -6px; 
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* --- Icon Placeholders (Replacing Lucide-React) --- */
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            vertical-align: middle;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .home-icon::before { content: 'üè†'; font-size: 24px; }
        .list-icon::before { content: 'üìã'; font-size: 24px; }
        .chevron-left-icon::before { content: '‚Üê'; font-size: 24px; }
        .trophy-icon::before { content: 'üèÜ'; font-size: 24px; }
        .star-icon::before { content: '‚≠ê'; font-size: 20px; }
        .volume-icon::before { content: 'üîä'; font-size: 20px; }

    </style>
</head>

<body>
    <div id="app-root" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col">
        <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 px-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-3xl font-bold">Class 6 - Object Detection: Parking Challenge</h1>
                    <div id="challenge-info" class="hidden flex items-center gap-4 bg-white/20 px-4 py-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="icon trophy-icon text-yellow-300"></i>
                            <span id="score-display" class="font-bold text-xl">0</span>
                        </div>
                        <div class="text-lg">
                            ‚è±Ô∏è <span id="time-left-display">30</span>s
                        </div>
                        <div class="flex items-center gap-1">
                            <i class="icon star-icon text-yellow-300"></i>
                            <span id="perfect-parks-display" class="font-bold">0</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="prev-page-btn" class="bg-white text-blue-600 rounded-full p-3 hover:bg-blue-50 transition-all shadow-md"
                        title="Previous Page">
                        <i class="icon chevron-left-icon"></i>
                    </button>
                    <button id="home-btn" class="bg-white text-blue-600 rounded-full p-3 hover:bg-blue-50 transition-all shadow-md"
                        title="Home">
                        <i class="icon home-icon"></i>
                    </button>
                    <button id="levels-btn" class="bg-white text-blue-600 rounded-full p-3 hover:bg-blue-50 transition-all shadow-md"
                        title="Levels">
                        <i class="icon list-icon"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex gap-6 p-6">
            <div class="w-1/4 bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Veera Kit</h3>
                <div class="bg-blue-100 rounded-lg p-4 border-4 border-blue-300">
                    <div class="text-center">
                        <div class="bg-blue-600 text-white rounded-lg p-6 mb-4">
                            <p class="text-sm font-semibold">VEERA KIT</p>
                            <p class="text-xs mt-2">Ultrasonic Sensor</p>
                        </div>
                        <div class="relative">
                            <div id="sensor-indicator"
                                class="w-full h-24 rounded-lg border-4 border-yellow-500 bg-yellow-100 flex items-center justify-center transition-all">
                                <div id="sensor-light" class="w-16 h-16 rounded-full bg-yellow-500"></div>
                            </div>
                            <p class="mt-2 text-sm font-semibold text-gray-700">Ultrasonic Sensor Active</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 space-y-3">
                    <button id="practice-mode-btn"
                        class="w-full py-3 px-4 rounded-lg font-bold transition-all bg-blue-500 text-white shadow-lg">
                        üéÆ Practice Mode
                    </button>
                    <button id="challenge-mode-btn"
                        class="w-full py-3 px-4 rounded-lg font-bold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                        üèÜ Challenge Mode
                    </button>
                    <button id="start-challenge-btn"
                        class="hidden w-full py-3 px-4 rounded-lg font-bold bg-green-500 text-white hover:bg-green-600 transition-all shadow-lg animate-pulse">
                        ‚ñ∂Ô∏è Start Challenge
                    </button>
                </div>

                <div id="challenge-details" class="hidden mt-4 bg-purple-50 rounded-lg p-4 border-2 border-purple-300">
                    <h4 class="font-bold text-purple-900 mb-2">Level <span id="challenge-level-display">1</span></h4>
                    <p class="text-sm text-gray-700">
                        Park as many times as possible in the safe zone! Perfect parks earn bonus points!
                    </p>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Parking Sensor Simulation</h3>
                    <div id="success-message" class="hidden bg-green-500 text-white px-6 py-2 rounded-full font-bold animate-bounce">
                        üéâ PERFECT PARK! +<span id="success-points">10</span> points!
                    </div>
                </div>

                <div class="relative bg-gradient-to-b from-sky-300 to-gray-300 rounded-lg h-96 overflow-hidden border-4 border-gray-400">
                    <div class="absolute top-4 left-4 text-4xl">‚òÅÔ∏è</div>
                    <div class="absolute top-8 right-20 text-4xl">‚òÅÔ∏è</div>
                    <div class="absolute top-4 right-4 text-3xl">‚òÄÔ∏è</div>

                    <div class="absolute bottom-0 w-full h-32 bg-gray-600">
                        <div class="flex justify-around h-full items-center">
                            <div class="w-16 h-1 bg-yellow-400"></div>
                            <div class="w-16 h-1 bg-yellow-400"></div>
                            <div class="w-16 h-1 bg-yellow-400"></div>
                            <div class="w-16 h-1 bg-yellow-400"></div>
                        </div>
                    </div>

                    <div id="safe-zone-indicator"
                        class="absolute bottom-32 bg-green-500/30 h-32 border-4 border-dashed border-green-600 transition-all"
                        style="right: 20%; width: 10%;">
                        <div
                            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                            SAFE ZONE
                        </div>
                    </div>

                    <div
                        class="absolute bottom-32 right-8 w-24 h-32 bg-gradient-to-b from-red-700 to-red-900 rounded-t-lg border-4 border-red-950">
                        <div class="absolute top-2 left-2 right-2 h-8 bg-red-600 rounded flex items-center justify-center">
                            <span class="text-white font-bold text-xs">STOP</span>
                        </div>
                        <div class="absolute bottom-2 left-2 right-2 space-y-1">
                            <div class="w-full h-2 bg-yellow-400"></div>
                            <div class="w-full h-2 bg-yellow-400"></div>
                        </div>
                    </div>

                    <div id="car-animation-container" class="absolute bottom-32 transition-all duration-300" style="right: 100%;">
                        <div class="relative">
                            <div id="car-body"
                                class="w-32 h-20 rounded-lg border-4 transition-all bg-blue-500 border-blue-700">
                                <div id="car-roof" class="absolute top-0 left-8 w-16 h-10 rounded-t-lg transition-all bg-blue-400"></div>
                                <div class="absolute top-1 left-10 w-5 h-8 bg-sky-200 rounded"></div>
                                <div class="absolute top-1 right-10 w-5 h-8 bg-sky-200 rounded"></div>
                                <div id="car-headlight" class="absolute top-8 right-1 w-3 h-3 rounded-full bg-yellow-300"></div>
                            </div>
                            <div class="absolute -bottom-2 left-2 w-8 h-8 bg-black rounded-full border-2 border-gray-400">
                                <div class="absolute inset-1 bg-gray-600 rounded-full"></div>
                            </div>
                            <div class="absolute -bottom-2 right-2 w-8 h-8 bg-black rounded-full border-2 border-gray-400">
                                <div class="absolute inset-1 bg-gray-600 rounded-full"></div>
                            </div>

                            <div id="sensor-waves" class="absolute right-0 top-8">
                                <div class="w-8 h-1 bg-blue-400 animate-pulse"></div>
                                <div class="w-12 h-1 bg-blue-400 opacity-70 mt-1 animate-pulse"></div>
                                <div class="w-16 h-1 bg-blue-400 opacity-40 mt-1 animate-pulse"></div>
                            </div>

                            <div id="perfect-park-stars"
                                class="hidden absolute -top-8 left-1/2 transform -translate-x-1/2">
                                <div class="flex gap-1 animate-bounce">
                                    <i class="icon star-icon text-yellow-400 fill-yellow-400"></i>
                                    <i class="icon star-icon text-yellow-400 fill-yellow-400"></i>
                                    <i class="icon star-icon text-yellow-400 fill-yellow-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="status-display-box" class="absolute top-4 left-4 right-4">
                        <div id="status-message-display"
                            class="bg-blue-500 text-white px-6 py-3 rounded-lg text-center font-bold text-lg shadow-lg transition-all">
                            üöó Keep Moving...
                        </div>
                    </div>

                    <div
                        class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-lg shadow-lg border-2 border-gray-300">
                        <p class="text-sm font-semibold text-gray-700">Distance: <span id="distance-value"
                                class="text-2xl text-blue-600">100</span> cm</p>
                    </div>
                </div>

                <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border-2 border-blue-300">
                    <h4 class="font-bold text-gray-800 mb-4 text-center text-lg">üéÆ Control Car Distance</h4>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-semibold text-gray-700 w-20">Far (100cm)</span>
                        <input type="range" min="0" max="100" value="100" id="car-position-slider"
                            class="flex-1 h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer slider" style="
                            background: linear-gradient(to right, 
                            red 0%, 
                            red 20%, 
                            green 20%, 
                            green 30%, 
                            yellow 30%, 
                            yellow 100%)
                        " />
                        <span class="text-sm font-semibold text-gray-700 w-20 text-right">Near (0cm)</span>
                    </div>
                    <p class="text-center mt-2 text-sm text-gray-600">
                        Drag the slider to move the car closer or farther from the obstacle
                    </p>
                </div>

                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                        <h4 class="font-bold text-gray-800 mb-2">üì° Sensor Reading</h4>
                        <div id="sensor-reading-box"
                            class="rounded-lg p-4 border-2 bg-white border-blue-400 transition-all">
                            <p id="sensor-reading" class="text-3xl font-bold text-center text-blue-600">
                                100 cm
                            </p>
                        </div>
                    </div>

                    <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-300">
                        <h4 class="font-bold text-gray-800 mb-2">‚öôÔ∏è Set Threshold</h4>
                        <div class="flex gap-2 mb-2">
                            <input type="number" value="20" id="manual-threshold-input"
                                class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 outline-none"
                                placeholder="Enter threshold" min="0" max="100" />
                            <span class="flex items-center text-gray-600 font-semibold">cm</span>
                        </div>
                        <div class="flex gap-2">
                            <button id="set-threshold-btn"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-md hover:shadow-lg transform hover:scale-105">
                                Set
                            </button>
                            <button id="reset-threshold-btn"
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-md hover:shadow-lg transform hover:scale-105">
                                Reset
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 text-center font-semibold">
                            Current Threshold: <span id="current-threshold-display" class="text-orange-600">20 cm</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="w-1/5 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Veera Guide</h3>
                <div class="relative">
                    <img src="lion.gif" alt="Veera Avatar" class="w-48 h-48 object-contain" />
                    <div id="voiceover-indicator" class="hidden absolute -top-2 -right-2 bg-green-500 rounded-full p-2 animate-pulse">
                        <i class="icon volume-icon text-white"></i>
                    </div>
                </div>
                <div class="mt-4 bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                    <p id="guide-message" class="text-sm text-gray-700 text-center leading-relaxed">
                        üéÆ Practice moving the car! Try to park it in the safe zone without hitting the obstacle.
                    </p>
                </div>

                <div class="mt-4 bg-yellow-50 rounded-lg p-4 border-2 border-yellow-300 w-full">
                    <h4 class="font-bold text-gray-800 mb-2 text-center">üí° Tips</h4>
                    <ul class="text-xs text-gray-700 space-y-1">
                        <li>‚Ä¢ Red = Danger Zone</li>
                        <li>‚Ä¢ Green = Safe Zone</li>
                        <li>‚Ä¢ Stars = Perfect Park!</li>
                        <li>‚Ä¢ Listen for buzzer in danger</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer class="bg-white py-4 px-6 shadow-lg">
            <div class="flex justify-center">
                <button id="next-experiment-btn"
                    class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-all shadow-md transform hover:scale-105">
                    Next Experiment ‚Üí
                    <a href="#" class="learn-more-link" onclick="goToPage('C6E1P1.html')" ; return false;">Continue to Part 3</a>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- STATE VARIABLES ---
        let sensorValue = 100;
        let threshold = 20;
        let manualThreshold = '20';
        let isVoiceoverPlaying = false;
        let score = 0;
        let attempts = 0;
        let gameMode = 'practice'; // 'practice', 'challenge'
        let challengeLevel = 1;
        let timeLeft = 30;
        let isGameActive = false;
        let showSuccess = false;
        let perfectParks = 0;

        // --- AUDIO REFERENCES ---
        let audioRef = null;
        const buzzerData = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWm98OScTgwOUKzn77dlGwU7k9rzxnklBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/LkkUYLEVm28OihUBELSKzn8LVgGgU7ldz1xXYnBSh+zPLaizsKFFyw6+2oVRILSKXh8bllHgQufM/z1YU2Bhxuv/Lkk=';
        const successData = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
        const buzzerRef = new Audio(buzzerData);
        const successRef = new Audio(successData);

        // --- DOM ELEMENTS (Cached) ---
        const sliderEl = document.getElementById('car-position-slider');
        const setThresholdBtn = document.getElementById('set-threshold-btn');
        const resetThresholdBtn = document.getElementById('reset-threshold-btn');
        const manualThresholdInput = document.getElementById('manual-threshold-input');
        const scoreDisplayEl = document.getElementById('score-display');
        const timeLeftDisplayEl = document.getElementById('time-left-display');
        const perfectParksDisplayEl = document.getElementById('perfect-parks-display');
        const sensorReadingEl = document.getElementById('sensor-reading');
        const distanceValueEl = document.getElementById('distance-value');
        const currentThresholdDisplayEl = document.getElementById('current-threshold-display');
        const sensorReadingBoxEl = document.getElementById('sensor-reading-box');
        const guideMessageEl = document.getElementById('guide-message');
        const challengeInfoEl = document.getElementById('challenge-info');
        const challengeDetailsEl = document.getElementById('challenge-details');
        const challengeLevelDisplayEl = document.getElementById('challenge-level-display');
        const startChallengeBtn = document.getElementById('start-challenge-btn');
        const practiceModeBtn = document.getElementById('practice-mode-btn');
        const challengeModeBtn = document.getElementById('challenge-mode-btn');
        const carAnimationContainerEl = document.getElementById('car-animation-container');
        const safeZoneIndicatorEl = document.getElementById('safe-zone-indicator');
        const sensorIndicatorEl = document.getElementById('sensor-indicator');
        const sensorLightEl = document.getElementById('sensor-light');
        const carBodyEl = document.getElementById('car-body');
        const carRoofEl = document.getElementById('car-roof');
        const carHeadlightEl = document.getElementById('car-headlight');
        const sensorWavesEl = document.getElementById('sensor-waves');
        const perfectParkStarsEl = document.getElementById('perfect-park-stars');
        const statusMessageDisplayEl = document.getElementById('status-message-display');
        const successMessageEl = document.getElementById('success-message');
        const successPointsEl = document.getElementById('success-points');
        const voiceoverIndicatorEl = document.getElementById('voiceover-indicator');

        // --- GAME LOGIC ---

        const updateUI = () => {
            const isWarning = sensorValue < threshold;
            const isSafeZone = sensorValue >= threshold && sensorValue <= (threshold + 10);
            const isPerfectPark = sensorValue >= threshold && sensorValue <= (threshold + 5);

            // 1. Update Distance Displays
            sliderEl.value = sensorValue;
            sensorReadingEl.textContent = `${sensorValue} cm`;
            distanceValueEl.textContent = sensorValue;
            carAnimationContainerEl.style.right = `${sensorValue}%`;

            // 2. Update Threshold Display
            currentThresholdDisplayEl.textContent = `${threshold} cm`;
            manualThresholdInput.value = manualThreshold;
            safeZoneIndicatorEl.style.right = `${threshold}%`;

            // 3. Update Car/Sensor Colors and Warnings
            let statusText = 'üöó Keep Moving...';
            let statusColorClass = 'bg-blue-500'; // Default
            let carBgClass = 'bg-blue-500 border-blue-700';

            // Function to safely replace Tailwind color/utility classes
            const replaceClasses = (element, regex, newClasses) => {
                element.className = element.className.replace(regex, '').trim();
                element.classList.add(...newClasses.split(' ').filter(c => c));
            };
            
            // Regex for all possible dynamic classes to remove before adding new ones
            const regex = /(bg-(red|green|yellow|blue|orange|purple|sky)-[1-9]00)\S*|(border-(red|green|yellow|blue)-[1-9]00)\S*|text-gray-900|text-blue-600|text-red-600|text-green-600|text-orange-600|animate-pulse|shadow-lg|shadow-green-500/g;


            // Clear previous classes
            replaceClasses(sensorReadingBoxEl, regex, 'rounded-lg p-4 border-2 transition-all');
            replaceClasses(sensorIndicatorEl, regex, 'w-full h-24 rounded-lg border-4 flex items-center justify-center transition-all');
            replaceClasses(sensorLightEl, regex, 'w-16 h-16 rounded-full');
            replaceClasses(carBodyEl, regex, 'w-32 h-20 rounded-lg border-4 transition-all');
            replaceClasses(carRoofEl, regex, 'absolute top-0 left-8 w-16 h-10 rounded-t-lg transition-all');
            replaceClasses(carHeadlightEl, regex, 'absolute top-8 right-1 w-3 h-3 rounded-full');
            
            // Sensor Waves & Status
            if (isPerfectPark) {
                statusText = '‚≠ê PERFECT PARKING! ‚≠ê';
                statusColorClass = 'bg-yellow-400 text-gray-900';
                carBgClass = 'bg-green-400 border-green-600 shadow-lg shadow-green-500';
                
                sensorReadingBoxEl.classList.add('bg-green-100', 'border-green-400');
                sensorReadingEl.classList.add('text-green-600');
                sensorIndicatorEl.classList.add('border-green-500', 'bg-green-100');
                sensorLightEl.classList.add('bg-green-500');
                carRoofEl.classList.add('bg-green-300');
                perfectParkStarsEl.classList.remove('hidden');

            } else if (isWarning) {
                statusText = '‚ö†Ô∏è WARNING: TOO CLOSE! DANGER!';
                statusColorClass = 'bg-red-500';
                carBgClass = 'bg-red-400 border-red-600 animate-pulse';

                sensorReadingBoxEl.classList.add('bg-red-100', 'border-red-400');
                sensorReadingEl.classList.add('text-red-600');
                sensorIndicatorEl.classList.add('border-red-500', 'bg-red-100');
                sensorLightEl.classList.add('bg-red-500', 'animate-pulse');
                carRoofEl.classList.add('bg-red-300');
                carHeadlightEl.classList.add('bg-red-500');
                perfectParkStarsEl.classList.add('hidden');

            } else if (isSafeZone) {
                statusText = '‚úì SAFE DISTANCE - GOOD JOB!';
                statusColorClass = 'bg-green-500';
                carBgClass = 'bg-green-400 border-green-600';
                
                sensorReadingBoxEl.classList.add('bg-green-100', 'border-green-400');
                sensorReadingEl.classList.add('text-green-600');
                sensorIndicatorEl.classList.add('border-green-500', 'bg-green-100');
                sensorLightEl.classList.add('bg-green-500');
                carRoofEl.classList.add('bg-green-300');
                perfectParkStarsEl.classList.add('hidden');

            } else {
                statusColorClass = 'bg-blue-500';
                carBgClass = 'bg-blue-500 border-blue-700';

                sensorReadingBoxEl.classList.add('bg-white', 'border-blue-400');
                sensorReadingEl.classList.add('text-blue-600');
                sensorIndicatorEl.classList.add('border-yellow-500', 'bg-yellow-100');
                sensorLightEl.classList.add('bg-yellow-500');
                carRoofEl.classList.add('bg-blue-400');
                carHeadlightEl.classList.add('bg-yellow-300');
                perfectParkStarsEl.classList.add('hidden');
            }

            // Apply new status classes
            statusMessageDisplayEl.className = `text-white px-6 py-3 rounded-lg text-center font-bold text-lg shadow-lg transition-all ${statusColorClass}`;
            statusMessageDisplayEl.textContent = statusText;
            
            carBodyEl.classList.add(...carBgClass.split(' ').filter(c => c));

            // 4. Update Slider Background (to show red/green zones)
            sliderEl.style.background = `linear-gradient(to right, 
                red 0%, 
                red ${threshold}%, 
                green ${threshold}%, 
                green ${threshold + 10}%, 
                yellow ${threshold + 10}%, 
                yellow 100%)`;

            // 5. Game Mode Specific UI updates
            if (gameMode === 'challenge' && isGameActive) {
                challengeInfoEl.classList.remove('hidden');
                scoreDisplayEl.textContent = score;
                timeLeftDisplayEl.textContent = timeLeft;
                perfectParksDisplayEl.textContent = perfectParks;
                challengeLevelDisplayEl.textContent = challengeLevel;
            } else {
                challengeInfoEl.classList.add('hidden');
            }
            
            // 6. Voiceover Indicator
            if (isVoiceoverPlaying) {
                voiceoverIndicatorEl.classList.remove('hidden');
            } else {
                voiceoverIndicatorEl.classList.add('hidden');
            }
        };

        const handleCarPositionChange = (e) => {
            const distance = parseInt(e.target.value);
            sensorValue = distance;

            // Send distance to kit via serial communication (Placeholder)
            console.log('Sending distance to kit:', distance);

            // Check if car is in danger zone
            if (distance < threshold) {
                // Play buzzer sound
                if (buzzerRef) {
                    buzzerRef.currentTime = 0;
                    buzzerRef.play().catch(e => console.log('Buzzer play error:', e));
                }
            }

            // Check for perfect parking in challenge mode
            if (isGameActive && gameMode === 'challenge') {
                const perfectRange = threshold + 5; // Perfect park is 5cm above threshold
                if (distance >= threshold && distance <= perfectRange) {
                    showSuccessMessage(challengeLevel * 10);
                }
            }

            updateUI();
        };

        const handleSetThreshold = () => {
            const value = parseInt(manualThresholdInput.value);
            if (!isNaN(value) && value >= 0 && value <= 100) {
                threshold = value;
                manualThreshold = value; // Update the internal state mirror
                console.log('Sending threshold to kit:', value);
            }
            updateUI();
        };

        const handleResetThreshold = () => {
            threshold = 20;
            manualThresholdInput.value = '20';
            manualThreshold = '20';
            console.log('Resetting threshold to default: 20');
            updateUI();
        };

        const startChallenge = () => {
            isGameActive = true;
            score = 0;
            attempts = 0;
            perfectParks = 0;
            timeLeft = 30;
            sensorValue = 100;
            updateUI();
            startTimer();
            startChallengeBtn.classList.add('hidden');
        };

        const endChallenge = () => {
            isGameActive = false;
            // Show final score (Could implement a modal here)
            alert(`Challenge Over! Final Score: ${score}. Perfect Parks: ${perfectParks}`);
            updateUI();
        };
        
        const startTimer = () => {
            let timerInterval = setInterval(() => {
                if (isGameActive && gameMode === 'challenge' && timeLeft > 0) {
                    timeLeft--;
                    updateUI();
                } else if (isGameActive && gameMode === 'challenge' && timeLeft === 0) {
                    clearInterval(timerInterval);
                    endChallenge();
                } else if (gameMode !== 'challenge' || !isGameActive) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        };

        const setGameMode = (mode) => {
            gameMode = mode;
            isGameActive = false;

            // Simple class toggling for button visual feedback (Tailwind required)
            if (mode === 'practice') {
                practiceModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                practiceModeBtn.classList.add('bg-blue-500', 'text-white', 'shadow-lg');
                challengeModeBtn.classList.remove('bg-purple-500', 'text-white', 'shadow-lg');
                challengeModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                startChallengeBtn.classList.add('hidden');
                challengeDetailsEl.classList.add('hidden');
                guideMessageEl.textContent = "üéÆ Practice moving the car! Try to park it in the safe zone without hitting the obstacle.";
            } else if (mode === 'challenge') {
                challengeModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                challengeModeBtn.classList.add('bg-purple-500', 'text-white', 'shadow-lg');
                practiceModeBtn.classList.remove('bg-blue-500', 'text-white', 'shadow-lg');
                practiceModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                startChallengeBtn.classList.remove('hidden');
                challengeDetailsEl.classList.remove('hidden');
                guideMessageEl.textContent = "üèÜ Challenge yourself! Park as many times as possible in 30 seconds. Perfect parks give bonus points!";
            }
            updateUI();
        };

        const showSuccessMessage = (points) => {
            if (successRef) {
                successRef.currentTime = 0;
                successRef.play().catch(e => console.log('Success sound error:', e));
            }
            score += points;
            perfectParks++;
            successPointsEl.textContent = points;
            successMessageEl.classList.remove('hidden');
            setTimeout(() => {
                successMessageEl.classList.add('hidden');
                updateUI();
            }, 2000);
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Voiceover Play (Equivalent to initial useEffect)
            audioRef = new Audio('class6-exp1-objectdetection-voiceover.mp3');
            audioRef.play().then(() => {
                isVoiceoverPlaying = true;
                updateUI();
            }).catch(err => {
                console.log('Voiceover autoplay prevented:', err);
            });

            audioRef.onended = () => {
                isVoiceoverPlaying = false;
                updateUI();
            };

            // Setup Event Listeners
            sliderEl.addEventListener('input', handleCarPositionChange);
            setThresholdBtn.addEventListener('click', handleSetThreshold);
            resetThresholdBtn.addEventListener('click', handleResetThreshold);
            startChallengeBtn.addEventListener('click', startChallenge);
            
            practiceModeBtn.addEventListener('click', () => setGameMode('practice'));
            challengeModeBtn.addEventListener('click', () => setGameMode('challenge'));
            
            // Placeholder button actions
            document.getElementById('prev-page-btn').addEventListener('click', () => console.log('Go to previous page'));
            document.getElementById('home-btn').addEventListener('click', () => console.log('Go to home'));
            document.getElementById('levels-btn').addEventListener('click', () => console.log('Go to levels'));
            document.getElementById('next-experiment-btn').addEventListener('click', () => console.log('Next experiment'));

            // Initial UI Render
            setGameMode('practice'); // Ensure initial mode is set
        });

    </script>

    <script>
        // Dummy functions for original HTML button clicks
        function goToPage(page) {
            window.location.href = page;
        }

        function goBack() {
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = '../page4.html';
            }
        }
    </script>
    <script src="SerialManager.js"></script>
    <script src="./backend/experimentControls.js"></script>
    <script src="../backend/renderer.js"></script>
</body>

</html>